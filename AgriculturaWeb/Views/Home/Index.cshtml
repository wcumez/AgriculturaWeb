@{
    ViewBag.Title = "Dashboard - AgriculturaWeb";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="container-fluid mt-4">
    <h2 class="text-success mb-4"><i class="fa-solid fa-leaf"></i> Panel de Control - AgriculturaWeb</h2>

    <!-- ====== TARJETAS DE TOTALES ====== -->
    <div class="row g-3">
        <div class="col-md-2">
            <div class="card text-white bg-success h-100 shadow-sm text-center">
                <div class="card-body">
                    <h6><i class="fa fa-tree"></i> Fincas</h6>
                    <h3>@ViewBag.TotalFincas</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-primary h-100 shadow-sm text-center">
                <div class="card-body">
                    <h6><i class="fa fa-user"></i> Empleados</h6>
                    <h3>@ViewBag.TotalEmpleados</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-info h-100 shadow-sm text-center">
                <div class="card-body">
                    <h6><i class="fa fa-box"></i> Productos</h6>
                    <h3>@ViewBag.TotalProductos</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-danger h-100 shadow-sm text-center">
                <div class="card-body">
                    <h6><i class="fa fa-money-bill"></i> Gastos</h6>
                    <h3>@($"Q{ViewBag.TotalGastos:N2}")</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== GRÁFICOS ====== -->
    <div class="row mt-5">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fa fa-chart-line"></i> Gastos Mensuales
                </div>
                <div class="card-body">
                    <canvas id="chartGastos"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <i class="fa fa-chart-pie"></i> Distribución de Cultivos
                </div>
                <div class="card-body">
                    <canvas id="chartCultivos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== TABLA DE STOCK ====== -->
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-secondary text-white">
            <i class="fa fa-warehouse"></i> Stock Actual de Productos
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Almacén</th>
                        <th>Stock Actual</th>
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.Stock != null)
                    {
                        foreach (var s in (IEnumerable<dynamic>)ViewBag.Stock)
                        {
                            <tr>
                                <td>@s.Producto</td>
                                <td>@s.Almacen</td>
                                <td>@s.StockActual</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="3">No hay datos disponibles.</td></tr>
                    }

                </tbody>
            </table>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // === OBTENER DATOS DESDE EL SERVIDOR (JSON) ===
    const gastosMes = JSON.parse('@Html.Raw(ViewBag.GastosMes ?? "[]")');
    const cultivos = JSON.parse('@Html.Raw(ViewBag.Cultivos ?? "[]")');

    // === GASTOS MENSUALES ===
    if (gastosMes.length > 0) {
        const labelsGastos = gastosMes.map(g => g.Mes);
        const dataGastos = gastosMes.map(g => g.Total);

        new Chart(document.getElementById("chartGastos"), {
            type: 'bar',
            data: {
                labels: labelsGastos,
                datasets: [{
                    label: 'Gastos por Mes (Q)',
                    data: dataGastos,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `Q${ctx.parsed.y.toFixed(2)}`
                        }
                    }
                }
            }
        });
    }

    // === DISTRIBUCIÓN DE CULTIVOS ===
    if (cultivos.length > 0) {
        const labelsCultivos = cultivos.map(c => c.Cultivo);
        const dataCultivos = cultivos.map(c => c.Cantidad);

        new Chart(document.getElementById("chartCultivos"), {
            type: 'pie',
            data: {
                labels: labelsCultivos,
                datasets: [{
                    data: dataCultivos,
                    backgroundColor: ['#198754', '#0dcaf0', '#ffc107', '#dc3545', '#6610f2', '#fd7e14']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    </script>
}
