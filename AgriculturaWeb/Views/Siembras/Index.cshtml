@model IEnumerable<AgriculturaWeb.Models.Siembra>
@{
    ViewBag.Title = "Listado de Siembras";
    var rolUsuario = Session["Rol"] != null ? Session["Rol"].ToString() : "";
}

<div class="container mt-4 mb-5">
    <!-- Título y botones -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-success fw-bold">
            <i class="fa-solid fa-seedling me-2"></i>Listado de Siembras
        </h3>
        <div>
            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary me-2">
                <i class="fa-solid fa-arrow-left"></i> Regresar al Panel
            </a>

            @if (rolUsuario == "Administrador")
            {
                <a href="@Url.Action("Create", "Siembras")" class="btn btn-success">
                    <i class="fa-solid fa-plus"></i> Nueva Siembra
                </a>
            }
        </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-success text-center">
                    <tr>
                        <th style="width: 10%;">ID</th>
                        <th>Lote</th>
                        <th>Variedad</th>
                        <th>Temporada</th>
                        <th>Fecha Siembra</th>
                        <th>Densidad de Plantas</th>
                        <th style="width: 160px;">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var s in Model)
                        {
                            <tr>
                                <td>@s.IdSiembra</td>
                                <td>@s.NombreLote</td>
                                <td>@s.NombreVariedad</td>
                                <td>@s.NombreTemporada</td>
                                <td>@s.FechaSiembra.ToShortDateString()</td>
                                <td>@s.DensidadPlantas</td>
                                <td>
                                    <a href="@Url.Action("Edit", "Siembras", new { id = s.IdSiembra })"
                                       class="btn btn-outline-primary btn-sm me-1">
                                        <i class="fa-solid fa-pen-to-square"></i> Editar
                                    </a>

                                    @if (rolUsuario == "Administrador")
                                    {
                                        using (Html.BeginForm("Delete", "Siembras", new { id = s.IdSiembra },
                                               FormMethod.Post, new { @class = "form-eliminar d-inline" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-outline-danger btn-sm me-1">
                                                <i class="fa-solid fa-trash"></i> Eliminar
                                            </button>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-muted text-center py-3">
                                <i class="fa-solid fa-circle-info text-secondary me-2"></i>
                                No hay registros de siembras aún.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pie -->
    <div class="text-center mt-3">
        <small class="text-muted">© @DateTime.Now.Year AgriculturaWeb — Módulo de Siembras</small>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Confirmación con SweetAlert2 antes de eliminar
        document.querySelectorAll('.form-eliminar').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Eliminar siembra?',
                    text: 'Esta acción no se puede deshacer.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(result => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });

        // Mostrar mensaje de resultado (éxito o error)
        @if (TempData["Mensaje"] != null)
        {
            var mensaje = TempData["Mensaje"].ToString();
            var icono = (!string.IsNullOrEmpty(mensaje) && mensaje.StartsWith("✅")) ? "success" : "error";

            <text>
                Swal.fire({
                    icon: '@icono',
                    title: 'Resultado',
                    text: `@mensaje.Replace("✅ ", "").Replace("❌ ", "")`
                });
            </text>
        }
    </script>
}
